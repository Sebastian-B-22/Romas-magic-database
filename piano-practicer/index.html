<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Music Practicer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            background: #111827;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: #1f2937;
            padding: 0.7rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .logo { font-size: 1.2rem; font-weight: 800; color: white; }
        .logo span { color: #a78bfa; }

        .header-buttons { display: flex; gap: 0.6rem; }

        .toggle-btn {
            padding: 0.5rem 1.2rem;
            border: 2px solid #374151;
            border-radius: 8px;
            background: transparent;
            color: #9ca3af;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn:hover { border-color: #a78bfa; color: #a78bfa; }
        .toggle-btn.active { background: #a78bfa; border-color: #a78bfa; color: white; }

        .rec-btn {
            padding: 0.5rem 1.2rem;
            border: 2px solid #ef4444;
            border-radius: 8px;
            background: transparent;
            color: #ef4444;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rec-btn:hover { background: #ef4444; color: white; }
        .rec-btn.recording { background: #ef4444; color: white; animation: blink-border 1s infinite; }
        @keyframes blink-border { 0%,100%{border-color:#ef4444} 50%{border-color:#fca5a5} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .timer { color: #9ca3af; font-size: 0.9rem; font-weight: 700; font-family: monospace; }
        .timer.recording { color: #ef4444; }

        /* Takes Panel */
        .takes-bar {
            background: #1f2937;
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-top: 1px solid #374151;
            flex-shrink: 0;
            min-height: 0;
            flex-wrap: wrap;
        }
        .takes-bar.hidden { display: none; }
        .takes-label { color: #6b7280; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        #takesList { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .take-chip {
            background: #374151; color: #c4b5fd;
            padding: 0.3rem 0.8rem; border-radius: 20px;
            font-size: 0.78rem; font-weight: 600; cursor: pointer;
            border: 1px solid #4c3d8a; transition: all 0.2s;
        }
        .take-chip:hover { background: #4c3d8a; color: white; }

        .takes-panel { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .take-chip {
            background: #374151; color: #c4b5fd;
            padding: 0.3rem 0.8rem; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            border: 1px solid #4c3d8a; transition: all 0.2s;
        }
        .take-chip:hover { background: #4c3d8a; color: white; }

        /* Visualizer */
        .visualizer {
            height: 45px;
            background: #0d1117;
            display: flex;
            align-items: flex-end;
            padding: 0 4px;
            gap: 2px;
            flex-shrink: 0;
        }
        .viz-bar {
            flex: 1;
            background: #a78bfa;
            border-radius: 2px 2px 0 0;
            height: 2px;
            transition: height 0.07s ease-out;
        }
        .viz-bar.black-viz { background: #7c3aed; }

        /* Piano Wrapper */
        .piano-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0.5rem 0.5rem 0.3rem;
        }

        /* Octave selector */
        .octave-selector {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.6rem;
            flex-shrink: 0;
        }

        .oct-btn {
            padding: 0.3rem 0.9rem;
            border: 2px solid #374151;
            border-radius: 6px;
            background: transparent;
            color: #9ca3af;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .oct-btn:hover { border-color: #a78bfa; color: #a78bfa; }
        .oct-btn.selected { background: #374151; color: white; border-color: #6b7280; }

        /* Piano */
        .piano {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 0;
        }

        .octave {
            flex: 1;
            display: flex;
            position: relative;
            height: 100%;
        }

        /* WHITE KEYS - big and chunky */
        .white-key {
            flex: 1;
            background: linear-gradient(180deg, #e0e0e0 0%, #ffffff 30%, #f5f5f5 100%);
            border: 2px solid #777;
            border-top: 4px solid #999;
            border-radius: 0 0 14px 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 1.5rem;
            box-shadow: 3px 6px 16px rgba(0,0,0,0.6), inset 0 -5px 8px rgba(0,0,0,0.08);
            position: relative;
            z-index: 1;
            transition: background 0.03s, transform 0.03s, box-shadow 0.03s;
            min-width: 60px;
        }

        .white-key:hover {
            background: linear-gradient(180deg, #ddd8ff 0%, #ede9ff 30%, #e5e2ff 100%);
        }

        .white-key.pressed {
            background: linear-gradient(180deg, #b3a5e8 0%, #c4b5fd 30%, #b3a5e8 100%) !important;
            box-shadow: 1px 3px 8px rgba(0,0,0,0.6), inset 0 -3px 6px rgba(0,0,0,0.1) !important;
            transform: translateY(4px) !important;
        }

        .note-name {
            font-size: clamp(0.9rem, 2vw, 1.4rem);
            font-weight: 900;
            color: #374151;
            line-height: 1;
        }

        .key-shortcut {
            font-size: clamp(0.6rem, 1.2vw, 0.9rem);
            color: #9ca3af;
            font-weight: 700;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }

        .show-shortcuts .white-key .key-shortcut,
        .show-shortcuts .black-key .key-shortcut { display: block; }

        /* BLACK KEYS - small, about an inch tall */
        .black-key {
            position: absolute;
            width: 36%;
            height: 100px;
            background: linear-gradient(180deg, #2a2a2a 0%, #111 55%, #333 100%);
            border-radius: 0 0 8px 8px;
            cursor: pointer;
            z-index: 2;
            transform: translateX(-50%);
            box-shadow: 3px 8px 14px rgba(0,0,0,0.8), inset 0 -3px 6px rgba(255,255,255,0.04);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 0.4rem;
            border-top: 4px solid #555;
            transition: background 0.03s, transform 0.03s, box-shadow 0.03s;
        }

        .black-key:hover {
            background: linear-gradient(180deg, #3b1d8a 0%, #2d27a3 55%, #3b1d8a 100%);
        }

        .black-key.pressed {
            background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 55%, #7c3aed 100%) !important;
            box-shadow: 1px 5px 10px rgba(0,0,0,0.8), inset 0 -2px 5px rgba(255,255,255,0.06) !important;
            transform: translateX(-50%) translateY(4px) !important;
        }

        .black-key .note-name {
            font-size: clamp(0.6rem, 1.1vw, 0.9rem);
            color: #c4b5fd;
            font-weight: 800;
        }

        .black-key .key-shortcut {
            font-size: clamp(0.45rem, 0.8vw, 0.65rem);
            background: #1a1a3a;
            color: #a78bfa;
            padding: 1px 4px;
            border-radius: 3px;
            margin-top: 3px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">üéπ Piano Music <span>Practicer</span></div>
    <div class="header-buttons">
        <div class="timer" id="timer">0:00</div>
        <button class="toggle-btn" id="btnKeyboard" onclick="toggleKeyboard()">‚å®Ô∏è Keyboard</button>
        <button class="rec-btn" id="btnRecord" onclick="toggleRecording()">‚è∫ Record</button>
    </div>
</header>

<div class="takes-bar hidden" id="takesBar">
    <span class="takes-label">üéµ Takes:</span>
    <div id="takesList"></div>
</div>

<div class="visualizer" id="visualizer"></div>

<div class="piano-wrapper">
    <div class="octave-selector" id="octaveSelector"></div>
    <div class="piano" id="piano"></div>
</div>

<script>
    // ‚îÄ‚îÄ Audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let audioCtx = null;
    function ctx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        return audioCtx;
    }

    const FREQS = {
        'C2':65.41,'C#2':69.30,'D2':73.42,'D#2':77.78,'E2':82.41,'F2':87.31,'F#2':92.50,'G2':98.00,'G#2':103.83,'A2':110.00,'A#2':116.54,'B2':123.47,
        'C3':130.81,'C#3':138.59,'D3':146.83,'D#3':155.56,'E3':164.81,'F3':174.61,'F#3':185.00,'G3':196.00,'G#3':207.65,'A3':220.00,'A#3':233.08,'B3':246.94,
        'C4':261.63,'C#4':277.18,'D4':293.66,'D#4':311.13,'E4':329.63,'F4':349.23,'F#4':369.99,'G4':392.00,'G#4':415.30,'A4':440.00,'A#4':466.16,'B4':493.88,
        'C5':523.25,'C#5':554.37,'D5':587.33,'D#5':622.25,'E5':659.25,'F5':698.46,'F#5':739.99,'G5':783.99,'G#5':830.61,'A5':880.00,'A#5':932.33,'B5':987.77,
    };

    // ‚îÄ‚îÄ Keyboard map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const KEY_MAP = {
        // Lower octave (C3‚ÄìB3)
        'z':'C3','s':'C#3','x':'D3','d':'D#3','c':'E3',
        'v':'F3','g':'F#3','b':'G3','h':'G#3','n':'A3','j':'A#3','m':'B3',
        // Upper octave (C4‚ÄìB4)
        'q':'C4','2':'C#4','w':'D4','3':'D#4','e':'E4',
        'r':'F4','5':'F#4','t':'G4','6':'G#4','y':'A4','7':'A#4','u':'B4',
        // Extra (C5)
        'i':'C5','9':'C#5','o':'D5','0':'D#5','p':'E5',
    };
    const NOTE_KEY = {};
    for (const [k,n] of Object.entries(KEY_MAP)) NOTE_KEY[n] = k.toUpperCase();

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const activeNodes = {};       // note ‚Üí audio nodes
    const heldByMouse = new Set();  // notes currently held by mouse
    const heldByKeys = new Set();   // notes currently held by keyboard
    const heldByTouch = new Map();  // touchId ‚Üí note

    let isRecording = false, recordedNotes = [], recordingStart = null;
    let timerInterval = null, savedTakes = [], takeCount = 0;
    let showShortcuts = false;
    let isMouseDown = false;

    // Which octaves to show
    const ALL_OCTAVES = [2, 3, 4, 5];
    let visibleOctaves = [3, 4, 5];

    // ‚îÄ‚îÄ Play / Release ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function playNote(note) {
        if (!FREQS[note] || activeNodes[note]) return;
        const ac = ctx();

        const osc1 = ac.createOscillator();
        const osc2 = ac.createOscillator();
        const gain = ac.createGain();

        osc1.type = 'triangle';
        osc1.frequency.value = FREQS[note];
        osc2.type = 'sine';
        osc2.frequency.value = FREQS[note] * 2.0015;

        const g2 = ac.createGain();
        g2.gain.value = 0.12;

        gain.gain.setValueAtTime(0, ac.currentTime);
        gain.gain.linearRampToValueAtTime(0.6, ac.currentTime + 0.008);
        gain.gain.exponentialRampToValueAtTime(0.3, ac.currentTime + 0.13);

        osc1.connect(gain); osc2.connect(g2); g2.connect(gain);
        gain.connect(ac.destination);
        osc1.start(); osc2.start();

        activeNodes[note] = { osc1, osc2, gain, g2 };

        // Visual
        const el = document.getElementById(`key-${note}`);
        if (el) el.classList.add('pressed');

        const bar = document.getElementById(`viz-${note}`);
        if (bar) {
            bar.style.height = `${20 + Math.random() * 23}px`;
            setTimeout(() => { if (bar) bar.style.height = '2px'; }, 170);
        }

        if (isRecording) recordedNotes.push({ note, time: Date.now() - recordingStart, type: 'on' });
    }

    function releaseNote(note) {
        // Only release if no source is still holding it
        if (heldByMouse.has(note) || heldByKeys.has(note)) return;
        for (const [, n] of heldByTouch) { if (n === note) return; }

        if (!activeNodes[note]) return;
        const ac = ctx();
        const { osc1, osc2, gain } = activeNodes[note];

        gain.gain.setValueAtTime(gain.gain.value, ac.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.55);
        osc1.stop(ac.currentTime + 0.55);
        osc2.stop(ac.currentTime + 0.55);
        delete activeNodes[note];

        const el = document.getElementById(`key-${note}`);
        if (el) el.classList.remove('pressed');

        if (isRecording) recordedNotes.push({ note, time: Date.now() - recordingStart, type: 'off' });
    }

    // ‚îÄ‚îÄ Mouse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('mousedown', () => isMouseDown = true);
    document.addEventListener('mouseup', () => {
        isMouseDown = false;
        const toRelease = [...heldByMouse];
        heldByMouse.clear();
        toRelease.forEach(releaseNote);
    });

    function onMouseDown(note) {
        heldByMouse.add(note);
        playNote(note);
    }
    function onMouseEnter(note) {
        if (!isMouseDown) return;
        heldByMouse.add(note);
        playNote(note);
    }
    function onMouseLeave(note) {
        heldByMouse.delete(note);
        releaseNote(note);
    }

    // ‚îÄ‚îÄ Touch (multi-finger) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function noteFromTouch(touch) {
        const el = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!el) return null;
        const key = el.closest('[id^="key-"]');
        return key ? key.id.replace('key-', '') : null;
    }

    document.addEventListener('touchstart', e => {
        e.preventDefault();
        for (const t of e.changedTouches) {
            const note = noteFromTouch(t);
            if (note) {
                heldByTouch.set(t.identifier, note);
                playNote(note);
            }
        }
    }, { passive: false });

    document.addEventListener('touchmove', e => {
        e.preventDefault();
        for (const t of e.changedTouches) {
            const newNote = noteFromTouch(t);
            const oldNote = heldByTouch.get(t.identifier);
            if (newNote !== oldNote) {
                if (oldNote) { heldByTouch.delete(t.identifier); releaseNote(oldNote); }
                if (newNote) { heldByTouch.set(t.identifier, newNote); playNote(newNote); }
            }
        }
    }, { passive: false });

    document.addEventListener('touchend', e => {
        e.preventDefault();
        for (const t of e.changedTouches) {
            const note = heldByTouch.get(t.identifier);
            if (note) { heldByTouch.delete(t.identifier); releaseNote(note); }
        }
    }, { passive: false });

    document.addEventListener('touchcancel', e => {
        for (const t of e.changedTouches) {
            const note = heldByTouch.get(t.identifier);
            if (note) { heldByTouch.delete(t.identifier); releaseNote(note); }
        }
    });

    // ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', e => {
        if (e.repeat || e.target.tagName === 'INPUT') return;
        const note = KEY_MAP[e.key.toLowerCase()];
        if (note && !heldByKeys.has(note)) {
            heldByKeys.add(note);
            playNote(note);
        }
    });
    document.addEventListener('keyup', e => {
        const note = KEY_MAP[e.key.toLowerCase()];
        if (note) {
            heldByKeys.delete(note);
            releaseNote(note);
        }
    });

    // ‚îÄ‚îÄ Build Piano ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const WHITES = ['C','D','E','F','G','A','B'];
    const BLACK_AFTER = { 'C':'C#', 'D':'D#', 'F':'F#', 'G':'G#', 'A':'A#' };

    function buildPiano() {
        const piano = document.getElementById('piano');
        const viz   = document.getElementById('visualizer');
        piano.innerHTML = ''; viz.innerHTML = '';

        visibleOctaves.forEach(oct => {
            const octDiv = document.createElement('div');
            octDiv.className = 'octave';

            WHITES.forEach((note, i) => {
                const full = `${note}${oct}`;

                // White key
                const wk = document.createElement('div');
                wk.className = 'white-key';
                wk.id = `key-${full}`;
                wk.innerHTML = `<span class="note-name">${note}</span>${NOTE_KEY[full] ? `<span class="key-shortcut">${NOTE_KEY[full]}</span>` : ''}`;
                wk.addEventListener('mousedown', e => { e.preventDefault(); onMouseDown(full); });
                wk.addEventListener('mouseenter', () => onMouseEnter(full));
                wk.addEventListener('mouseleave', () => onMouseLeave(full));
                octDiv.appendChild(wk);

                // Viz bar
                const bar = document.createElement('div');
                bar.className = 'viz-bar';
                bar.id = `viz-${full}`;
                viz.appendChild(bar);

                // Black key
                if (BLACK_AFTER[note]) {
                    const sharp = `${BLACK_AFTER[note]}${oct}`;
                    const bk = document.createElement('div');
                    bk.className = 'black-key';
                    bk.id = `key-${sharp}`;
                    bk.style.left = `${(i + 1) * (100 / 7)}%`;
                    bk.innerHTML = `<span class="note-name">${BLACK_AFTER[note]}‚ôØ</span>${NOTE_KEY[sharp] ? `<span class="key-shortcut">${NOTE_KEY[sharp]}</span>` : ''}`;
                    bk.addEventListener('mousedown', e => { e.preventDefault(); onMouseDown(sharp); });
                    bk.addEventListener('mouseenter', () => onMouseEnter(sharp));
                    bk.addEventListener('mouseleave', () => onMouseLeave(sharp));
                    octDiv.appendChild(bk);

                    const sbar = document.createElement('div');
                    sbar.className = 'viz-bar black-viz';
                    sbar.id = `viz-${sharp}`;
                    viz.appendChild(sbar);
                }
            });

            piano.appendChild(octDiv);
        });

        // Sync shortcuts visibility
        piano.classList.toggle('show-shortcuts', showShortcuts);
    }

    // ‚îÄ‚îÄ Octave Selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildOctaveSelector() {
        const sel = document.getElementById('octaveSelector');
        sel.innerHTML = '';
        ALL_OCTAVES.forEach(oct => {
            const btn = document.createElement('button');
            btn.className = 'oct-btn' + (visibleOctaves.includes(oct) ? ' selected' : '');
            btn.textContent = `Octave ${oct}`;
            btn.onclick = () => {
                if (visibleOctaves.includes(oct)) {
                    if (visibleOctaves.length > 1) visibleOctaves = visibleOctaves.filter(o => o !== oct);
                } else {
                    visibleOctaves = [...visibleOctaves, oct].sort();
                }
                buildOctaveSelector();
                buildPiano();
            };
            sel.appendChild(btn);
        });
    }

    // ‚îÄ‚îÄ UI Toggles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleKeyboard() {
        showShortcuts = !showShortcuts;
        document.getElementById('piano').classList.toggle('show-shortcuts', showShortcuts);
        document.getElementById('btnKeyboard').classList.toggle('active', showShortcuts);
    }

    // ‚îÄ‚îÄ Recording ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleRecording() {
        if (isRecording) {
            // STOP
            isRecording = false;
            clearInterval(timerInterval);
            const btn = document.getElementById('btnRecord');
            btn.textContent = '‚è∫ Record';
            btn.classList.remove('recording');
            document.getElementById('timer').className = 'timer';

            if (recordedNotes.length) {
                takeCount++;
                const dur = document.getElementById('timer').textContent;
                savedTakes.push({ notes: [...recordedNotes], label: `Take ${takeCount}`, duration: dur });
                updateTakes();
                document.getElementById('takesBar').classList.remove('hidden');
            }
        } else {
            // START
            isRecording = true;
            recordedNotes = [];
            recordingStart = Date.now();
            const btn = document.getElementById('btnRecord');
            btn.textContent = '‚èπ Stop';
            btn.classList.add('recording');
            document.getElementById('timer').className = 'timer recording';
            document.getElementById('timer').textContent = '0:00';

            let s = 0;
            timerInterval = setInterval(() => {
                s++;
                document.getElementById('timer').textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            }, 1000);
        }
    }

    function doPlayback(notes) {
        document.getElementById('btnRecord').disabled = true;
        notes.forEach(ev => {
            setTimeout(() => { ev.type === 'on' ? playNote(ev.note) : releaseNote(ev.note); }, ev.time);
        });
        const maxTime = Math.max(...notes.map(n => n.time)) + 1200;
        setTimeout(() => { document.getElementById('btnRecord').disabled = false; }, maxTime);
    }

    function updateTakes() {
        const list = document.getElementById('takesList');
        list.innerHTML = '';
        savedTakes.forEach(take => {
            const chip = document.createElement('div');
            chip.className = 'take-chip';
            chip.textContent = `‚ñ∂ ${take.label} (${take.duration})`;
            chip.onclick = () => doPlayback(take.notes);
            list.appendChild(chip);

            // Delete button
            const del = document.createElement('span');
            del.textContent = ' ‚úï';
            del.style.cssText = 'cursor:pointer;color:#6b7280;margin-right:0.3rem;';
            del.onclick = e => {
                e.stopPropagation();
                savedTakes = savedTakes.filter(t => t !== take);
                updateTakes();
                if (!savedTakes.length) document.getElementById('takesBar').classList.add('hidden');
            };
            chip.appendChild(del);
        });
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    buildOctaveSelector();
    buildPiano();
</script>
</body>
</html>
